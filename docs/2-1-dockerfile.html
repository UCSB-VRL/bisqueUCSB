<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="2.1 Dockerfile | Getting Started with BisQue" />
<meta property="og:type" content="book" />

<meta property="og:image" content="images/cover.png" />
<meta property="og:description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud." />




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>

<meta name="description" content="BisQue (Bio-Image Semantic Query User Environment) : Store, visualize,organize and analyze images in the cloud.">

<title>2.1 Dockerfile | Getting Started with BisQue</title>

<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="style.css" type="text/css" />

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li><a href="index.html#cloud-service-module-development-python-api">Cloud Service | Module Development | Python API</a>
<ul>
<li><a href="docker-installation.html#docker-installation">Docker Installation</a>
<ul>
<li><a href="docker-installation.html#intro-bisque-docker-container"><strong>Intro: BisQue Docker Container</strong></a></li>
</ul></li>
</ul></li>
<li><a href="1-intro.html#intro"><span class="toc-section-number">1</span> BisQue Cloud Service</a>
<ul>
<li><a href="1-1-how-to-login-or-create-a-new-user.html#how-to-login-or-create-a-new-user"><span class="toc-section-number">1.1</span> How to Login or Create a New User</a></li>
<li><a href="1-2-how-to-upload-data.html#how-to-upload-data"><span class="toc-section-number">1.2</span> How to Upload Data</a>
<ul>
<li><a href="1-2-how-to-upload-data.html#step-1.-login">Step 1. Login</a></li>
<li><a href="1-2-how-to-upload-data.html#step-2.-upload-file-or-folder">Step 2. Upload File or Folder</a></li>
<li><a href="1-2-how-to-upload-data.html#step-3.-build-a-dataset">Step 3. Build a Dataset</a></li>
<li><a href="1-2-how-to-upload-data.html#step-4.-setting-permissions">Step 4. Setting Permissions</a></li>
</ul></li>
<li><a href="1-3-how-to-add-annotations.html#how-to-add-annotations"><span class="toc-section-number">1.3</span> How to Add Annotations</a>
<ul>
<li><a href="1-3-how-to-add-annotations.html#overview">Overview</a></li>
</ul></li>
<li><a href="1-4-how-to-run-a-module.html#how-to-run-a-module"><span class="toc-section-number">1.4</span> How to Run a Module</a></li>
<li><a href="1-5-imagej-module.html#imagej-module"><span class="toc-section-number">1.5</span> ImageJ Module</a>
<ul>
<li><a href="1-5-imagej-module.html#overview-1">Overview</a></li>
<li><a href="1-5-imagej-module.html#uploading-of-imagej-pipelines">Uploading of ImageJ Pipelines</a></li>
<li><a href="1-5-imagej-module.html#running-an-imagej-macro">Running an ImageJ Macro</a></li>
<li><a href="1-5-imagej-module.html#special-bisque-extensions-for-imagej">Special BisQue extensions for ImageJ</a></li>
</ul></li>
<li><a href="1-6-cellprofiler-module.html#cellprofiler-module"><span class="toc-section-number">1.6</span> CellProfiler Module</a>
<ul>
<li><a href="1-6-cellprofiler-module.html#overview-2">Overview</a></li>
<li><a href="1-6-cellprofiler-module.html#uploading-of-cellprofiler-pipelines">Uploading of CellProfiler Pipelines</a></li>
<li><a href="1-6-cellprofiler-module.html#running-a-cellprofiler-pipeline">Running a CellProfiler Pipeline</a></li>
<li><a href="1-6-cellprofiler-module.html#results">Results</a></li>
</ul></li>
<li><a href="1-7-plant-cell-segmentation.html#plant-cell-segmentation"><span class="toc-section-number">1.7</span> Plant Cell Segmentation</a>
<ul>
<li><a href="1-7-plant-cell-segmentation.html#overview-3">Overview</a></li>
<li><a href="1-7-plant-cell-segmentation.html#input"><strong><code>Input</code></strong></a></li>
<li><a href="1-7-plant-cell-segmentation.html#hyperparameters">Hyperparameters</a></li>
<li><a href="1-7-plant-cell-segmentation.html#cell-features">Cell Features</a></li>
<li><a href="1-7-plant-cell-segmentation.html#output"><strong><code>Output</code></strong></a></li>
</ul></li>
</ul></li>
<li><a href="2-module-development.html#module-development"><span class="toc-section-number">2</span> Module Development</a>
<ul>
<li><a href="2-module-development.html#how-to-begin-building-modules"><strong>How to Begin Building Modules</strong></a></li>
<li><a href="2-1-dockerfile.html#dockerfile"><span class="toc-section-number">2.1</span> Dockerfile</a>
<ul>
<li><a href="2-1-dockerfile.html#example-composite-strength"><strong>Example: Composite Strength</strong></a></li>
</ul></li>
<li><a href="2-2-module-xml.html#module-xml"><span class="toc-section-number">2.2</span> Module XML</a>
<ul>
<li><a href="2-2-module-xml.html#example"><strong>Example</strong></a></li>
<li><a href="2-2-module-xml.html#module-description">Module Description</a></li>
<li><a href="2-2-module-xml.html#configurations-for-images-datasets-and-resources">Configurations for Images, Datasets, and Resources</a></li>
<li><a href="2-2-module-xml.html#data-parallel-execution">Data-Parallel Execution</a></li>
</ul></li>
<li><a href="2-3-python-script-wrapper.html#python-script-wrapper"><span class="toc-section-number">2.3</span> Python Script Wrapper</a>
<ul>
<li><a href="2-3-python-script-wrapper.html#example.-python-script-wrapper"><em>Example.</em> Python Script Wrapper</a></li>
</ul></li>
<li><a href="2-4-source-code.html#source-code"><span class="toc-section-number">2.4</span> Source Code</a>
<ul>
<li><a href="2-4-source-code.html#example.-composite-strength-module"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li><a href="2-5-runtime-module-configuration.html#runtime-module-configuration"><span class="toc-section-number">2.5</span> Runtime Module Configuration</a>
<ul>
<li><a href="2-5-runtime-module-configuration.html#example.-composite-strength-module-1"><em>Example.</em> Composite Strength Module</a></li>
</ul></li>
<li><a href="2-6-python-setup.html#python-setup"><span class="toc-section-number">2.6</span> Python Setup</a></li>
</ul></li>
<li><a href="3-bqapi.html#bqapi"><span class="toc-section-number">3</span> BQAPI</a>
<ul>
<li><a href="download-an-array.html#download-an-array"><strong>Download an Array</strong></a>
<ul>
<li><a href="download-an-array.html#access-an-hdf5-table-from-bisque">Access an HDF5 Table from BisQue</a></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="dockerfile" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Dockerfile</h2>
<blockquote>
<p><strong>FILENAME: </strong> <code>Dockerfile</code> This file will be used for the docker build process so try to keep the default naming convention.</p>
</blockquote>
<div id="defining-a-base-image" class="section level4 unnumbered" number="">
<h4>Defining a Base Image</h4>
<p>Typically, a <code>Dockerfile</code> will include a base image such as <code>FROM ubuntu:xenial</code> at the top of the file. We highly recommend using the Ubuntu Xenial 16.04 image for your module as it has been tested rigorously and is the base image we use for BisQue.</p>
<p><strong>NOTE.</strong> If you would like to use a different Ubuntu flavor like 18.04 Bionic, we encourage you to do so and let us know of any problems you encounter.</p>
<p>We typically start off our module Dockerfiles with the following lines:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb30-1"><a href="2-1-dockerfile.html#cb30-1"></a><span class="ex">FROM</span> ubuntu:xenial</span>
<span id="cb30-2"><a href="2-1-dockerfile.html#cb30-2"></a><span class="ex">ENV</span> DEBIAN_FRONTEND noninteractive</span>
<span id="cb30-3"><a href="2-1-dockerfile.html#cb30-3"></a><span class="ex">RUN</span> apt-get -y update   <span class="kw">&amp;&amp;</span> <span class="kw">\</span></span>
<span id="cb30-4"><a href="2-1-dockerfile.html#cb30-4"></a>    <span class="ex">apt-get</span> -y upgrade  <span class="kw">&amp;&amp;</span> <span class="kw">\</span></span>
<span id="cb30-5"><a href="2-1-dockerfile.html#cb30-5"></a>    <span class="ex">apt-get</span> -y install python</span></code></pre></div>
</div>
<div id="apt-get-installs" class="section level4 unnumbered" number="">
<h4>APT-GET Installs</h4>
<p>After these lines, we need to add dependencies for our module such as pip, headers, and any compilers. The next few lines are where we put any <code>apt-get</code> installs. Usually this is good practice since some pip install packages require a compiler. If one is not present in the container, it might be hard to debug what is missing.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb31-1"><a href="2-1-dockerfile.html#cb31-1"></a><span class="ex">RUN</span> apt-get -y install python-pip liblapack3 libblas-dev liblapack-dev gfortran</span>
<span id="cb31-2"><a href="2-1-dockerfile.html#cb31-2"></a><span class="ex">RUN</span> apt-get update   <span class="co"># &lt;--- Run before pip installs</span></span></code></pre></div>
</div>
<div id="pip-installs" class="section level4 unnumbered" number="">
<h4>PIP Installs</h4>
<p>Now we add any pip installs that our module may need such as <code>numpy</code>, <code>pandas</code>, <code>Tensorflow</code>, and any others. If you used a virtual environment to develop module locally, and hopefully you did, then simply use <code>pip freeze &gt; requirements.txt</code>. This will give you a text file with all the packages you are using in your virtual environment for your module. If you are a diligent person, you probably do not use one virtual environment for all your development in, say, Python 3.6. Hence, you will only have the necessary packages in the <code>requirements.txt</code> file. From this file, fill in the necessary pip installs within the Dockerfile.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb32-1"><a href="2-1-dockerfile.html#cb32-1"></a><span class="ex">RUN</span> pip install numpy pandas tensorflow</span>
<span id="cb32-2"><a href="2-1-dockerfile.html#cb32-2"></a><span class="ex">RUN</span> pip install scikit-learn==0.19.1   <span class="co"># &lt;--- For specific versions</span></span>
<span id="cb32-3"><a href="2-1-dockerfile.html#cb32-3"></a><span class="ex">RUN</span> pip install -i https://biodev.ece.ucsb.edu/py/bisque/prod/+simple bisque-api==0.5.9</span></code></pre></div>
</div>
<div id="working-directory-source-code" class="section level4 unnumbered" number="">
<h4>Working Directory, Source Code</h4>
<p>We typically define the working directory as follows:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb33-1"><a href="2-1-dockerfile.html#cb33-1"></a><span class="ex">WORKDIR</span> /module</span></code></pre></div>
<p>After this, you can put all of your source code along with the <code>PythonScriptWrapper</code> inside the <code>/modules</code> directory.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb34-1"><a href="2-1-dockerfile.html#cb34-1"></a><span class="ex">COPY</span> PythonScriptWrapper /module/</span>
<span id="cb34-2"><a href="2-1-dockerfile.html#cb34-2"></a><span class="ex">COPY</span> PythonScriptWrapper.py /module/</span>
<span id="cb34-3"><a href="2-1-dockerfile.html#cb34-3"></a><span class="ex">COPY</span> YOUR_MODULE_SCRIPT.py /module/  <span class="co">#  &lt;--- Source folders welcome too</span></span>
<span id="cb34-4"><a href="2-1-dockerfile.html#cb34-4"></a><span class="ex">COPY</span> pydist /module/pydist/</span>
<span id="cb34-5"><a href="2-1-dockerfile.html#cb34-5"></a><span class="ex">ENV</span> PATH /module:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></code></pre></div>
<p>The last line is the <code>ENV</code> instruction which sets the environment variable <code>&lt;key&gt;</code> to the value <code>&lt;value&gt;</code>. This value will be in the environment for all subsequent instructions in the build stage and can be replaced inline in many as well.</p>
</div>
<div id="what-should-my-last-line-be" class="section level4 unnumbered" number="">
<h4>What Should My Last Line Be?</h4>
<p>Your last line in the Dockerfile should be the <code>CMD</code> command. There can only be one <code>CMD</code> instruction in a Dockerfile. If you list more than one <code>CMD</code> then only the last <code>CMD</code> will take effect.</p>
<blockquote>
<p>The main purpose of a <code>CMD</code> is to provide defaults for an executing container.</p>
</blockquote>
<p>For us, we will use the <code>PythonScriptWrapper</code> as our <code>CMD</code> command as follows:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb35-1"><a href="2-1-dockerfile.html#cb35-1"></a><span class="ex">CMD</span> [ <span class="st">&#39;PythonScriptWrapper&#39;</span> ]</span></code></pre></div>
<p>Simple, am I right? Letâ€™s put all this together in a concrete example.</p>
<hr />
</div>
<div id="example-composite-strength" class="section level3 unnumbered" number="">
<h3><strong>Example: Composite Strength</strong></h3>
<p>The Composite Strength module requires a variety of special packages, such as a very specific version of <code>scikit-learn==0.19.1</code>. Please be aware that if you do pickle files using <code>scikit-learn</code>, you might have to use the same exact version to unpickle the file. Some of us found that out the hard way, hence the word of caution.</p>
<p>This simple mistake can be extended to any number of machine learning tasks. We recommend that for <em>maximum reproducibility</em>, use the exact same version of all pip install packages as you did on your local development environment.</p>
<div id="step-1.-define-base-image-run-apt-gets-install-python" class="section level4 unnumbered" number="">
<h4>Step 1. Define Base Image, Run apt-gets, Install Python</h4>
<p>Similar to before, we will define our base image of Ubuntu Xenial, run the necessary <code>apt-gets</code> which is crucial, and install <code>Python</code>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb36-1"><a href="2-1-dockerfile.html#cb36-1"></a><span class="ex">FROM</span> ubuntu:xenial</span>
<span id="cb36-2"><a href="2-1-dockerfile.html#cb36-2"></a><span class="ex">ENV</span> DEBIAN_FRONTEND noninteractive</span>
<span id="cb36-3"><a href="2-1-dockerfile.html#cb36-3"></a><span class="ex">RUN</span> apt-get -y update                                            <span class="kw">&amp;&amp;</span> <span class="kw">\</span></span>
<span id="cb36-4"><a href="2-1-dockerfile.html#cb36-4"></a>    <span class="ex">apt-get</span> -y upgrade                                           <span class="kw">&amp;&amp;</span> <span class="kw">\</span></span>
<span id="cb36-5"><a href="2-1-dockerfile.html#cb36-5"></a>    <span class="ex">apt-get</span> -y install                                              \</span>
<span id="cb36-6"><a href="2-1-dockerfile.html#cb36-6"></a>      python</span></code></pre></div>
</div>
<div id="step-2.-install-needed-apt-get-packages-and-dependencies" class="section level4 unnumbered" number="">
<h4>Step 2. Install Needed apt-get Packages and Dependencies</h4>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb37-1"><a href="2-1-dockerfile.html#cb37-1"></a><span class="ex">RUN</span> apt-get -y install python-lxml python-numpy</span>
<span id="cb37-2"><a href="2-1-dockerfile.html#cb37-2"></a><span class="ex">RUN</span> apt-get -y install python-pip liblapack3 libblas-dev liblapack-dev gfortran</span>
<span id="cb37-3"><a href="2-1-dockerfile.html#cb37-3"></a><span class="ex">RUN</span> apt-get -y install python-scipy python-configparser python-h5py</span>
<span id="cb37-4"><a href="2-1-dockerfile.html#cb37-4"></a><span class="ex">RUN</span> apt-get update</span></code></pre></div>
</div>
<div id="step-3.-install-needed-pip-packages-and-dependencies" class="section level4 unnumbered" number="">
<h4>Step 3. Install Needed PIP Packages and Dependencies</h4>
<p>Best practice is always to have your pip installs defined in the Dockerfile instead of in a <code>requirements.txt</code>. The more self-contained, the better.</p>
<p>Additionally, <strong>do not forget to install the <code>BQAPI</code> inside the container.</strong></p>
<pre><code>RUN pip install pymks tables scipy
RUN pip install --user --install-option=&quot;--prefix=&quot; -U scikit-learn==0.19.1
RUN pip install -i https://biodev.ece.ucsb.edu/py/bisque/prod/+simple bisque-api==0.5.9
RUN pip install requests==2.10.0</code></pre>
</div>
<div id="step-4.-set-working-directory-and-copy-source-files" class="section level4 unnumbered" number="">
<h4>Step 4. Set Working Directory and COPY Source files</h4>
<p>The working directory should be defined as <code>/module</code> and in there, dump all your source code. If you want to be clean, use a <code>/source</code> folder in the <code>/module</code> directory. This is your module container and you have the control to customize the structure in any way that seems feasible to you. In this example, there is only one script that performs the entire analysis pipeline. Some might say too simple, others say efficient.</p>
<pre><code>WORKDIR /module
COPY PythonScriptWrapper /module/
COPY PythonScriptWrapper.py /module/
COPY predict_strength.py /module/
COPY pydist /module/pydist/
ENV PATH /module:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</code></pre>
</div>
<div id="step-5.-lastly-the-final-command." class="section level4 unnumbered" number="">
<h4>Step 5. Lastly, the Final Command.</h4>
<p>Your final command should come as no surprise. The reason we use the PythonScriptWrapper is because it makes life easier for you. Your focus should be on developing breakthrough methods, not how to handshake between a cloud platform and a Docker container.</p>
<pre><code>CMD [ &#39;PythonScriptWrapper&#39; ]</code></pre>
</div>
</div>
</div>
<p style="text-align: center;">
<a href="2-module-development.html"><button class="btn btn-default">Previous</button></a>
<a href="2-2-module-xml.html"><button class="btn btn-default">Next</button></a>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
